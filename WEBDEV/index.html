<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- AUTH CHECK -->
  <script>
    if (!localStorage.getItem('slsu_token')) {
      window.location.href = 'login.html';
    }
  </script>
  <title>SLSU Marketplace</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/marketplace.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
</head>
<body>
  <!-- NAV -->
  <nav>
    <div class="nav__inner">
      <div class="nav__logo">
        <img src="assets/logo.png" alt="SLSU" onerror="this.style.display='none'" />
        <span class="site-title">SLSU <span class="accent">Marketplace</span></span>
      </div>

      <div style="flex:1;"></div>

      <div class="toolbar" style="display:flex; gap:1rem; align-items:center;">
        <button class="btn btn-outline" onclick="route('browse')">Browse</button>
        <button class="btn btn-outline" onclick="route('my')">My Dashboard</button>

        <!-- Cart -->
        <button class="btn btn-outline" id="openCart" style="padding:0.5rem 0.8rem;">
          <i class="ri-shopping-cart-2-line"></i><span id="cartCount">0</span>
        </button>

        <!-- Profile avatar -->
        <button class="profile-btn" id="openProfile" title="Profile">
          <div class="avatar profile-avatar-letter">U</div>
        </button>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="section__container" id="heroHeader">
    <div class="hero-banner">
      <h1>Buy & Sell within SLSU</h1>
      <div class="searchbar">
        <input type="text" id="q" placeholder="Search items..." />
        <button class="btn" id="runSearch"><i class="ri-search-line"></i> Search</button>
      </div>
    </div>
  </header>

  <!-- BROWSE -->
  <section class="section__container" id="browseSection">
    <div class="category-scroll-container">
      <div id="categoryIcons" class="category-row"></div>
    </div>

    <div class="browse-layout-grid">
      <div class="browse-main">
        <div class="section-flex-header">
          <h2 class="section-title">Active Shops</h2>
          <button class="btn-link" onclick="viewAllBiz()">View All <i class="ri-arrow-right-line"></i></button>
        </div>
        <div id="featuredBizRow" class="featured-biz-row"></div>

        <h2 class="section-title" style="margin-top:2rem; margin-bottom:1rem;">Fresh Listings</h2>
        <div class="grid grid-3" id="listings"></div>
        <div class="empty" id="emptyListings" style="display:none;">
          <i class="ri-store-2-line"></i> No items match your filters yet.
        </div>
      </div>

      <!-- Right-side Top Rated -->
      <aside class="browse-sidebar">
        <div class="sidebar-header">
          <h3>Top Rated</h3>
          <span style="font-size:0.8rem; color:var(--accent);">Live Now</span>
        </div>
        <div id="activeBizList" class="ranked-list"></div>
      </aside>
    </div>
  </section>

  <!-- BUSINESS PAGE -->
  <section class="section__container" id="businessPage" style="display:none;">
    <button class="btn btn-outline" onclick="route('browse')" style="margin-bottom:1rem;">
      <i class="ri-arrow-left-line"></i> Back to Marketplace
    </button>
    <div id="bizHeader" style="background:var(--surface-2); padding:2rem; border-radius:20px; border:1px solid var(--stroke); margin-bottom:2rem; display:flex; gap:1.5rem; flex-wrap:wrap;"></div>
    <h3 class="section__header" id="bizItemsTitle" style="font-size:1.5rem;">Menu & Services</h3>
    <div class="grid grid-3" id="bizItemsGrid"></div>
    <div class="empty" id="bizItemsEmpty" style="display:none;">
      <i class="ri-file-list-3-line"></i> This business hasn't listed any items yet.
    </div>
  </section>

  <!-- SELL FORM -->
  <section class="section__container" id="sellSection" style="display:none;">
    <h2 class="section__header">List an item / Add to Menu</h2>
    <form id="sellForm" class="form">
      <input type="hidden" name="businessId" id="linkToBizId" value="" />
      <div id="bizLinkNotice" style="background:rgba(34,197,94,.1); color:#86efac; padding:0.8rem; border-radius:8px; display:none; margin-bottom:1rem;">
        <i class="ri-link"></i> Adding this item to your business: <b id="bizLinkName"></b>
      </div>
      <div class="grid grid-2">
        <div class="input">
          <label>Item Title</label>
          <input required name="title" placeholder="e.g., Cheese Burger" />
        </div>
        <div class="input">
          <label>Price (PHP)</label>
          <input required name="price" type="number" min="0" step="0.01" />
        </div>
      </div>
      <div class="grid grid-2">
        <div class="input">
          <label>Category</label>
          <select name="category" required>
            <option value="Food & Drinks">Food & Drinks</option>
            <option value="Services">Services</option>
            <option value="Merch & Printing">Merch & Printing</option>
            <option value="Books">Books</option>
            <option value="Uniforms">Uniforms</option>
            <option value="Electronics">Electronics</option>
            <option value="Others">Others</option>
          </select>
        </div>
        <div class="input">
          <label>Condition</label>
          <select name="condition" required>
            <option>New / Fresh</option>
            <option>Service</option>
            <option>Like New</option>
            <option>Good</option>
          </select>
        </div>
      </div>
      <div class="input">
        <label>Description</label>
        <textarea name="description" rows="4"></textarea>
      </div>
      <div class="grid grid-2">
        <div class="input">
          <label>Photo</label>
          <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
            <label for="sellFile" class="btn" style="padding:0.6rem 1rem; width:auto;">
              <i class="ri-camera-fill"></i> Take Photo
            </label>
            <span id="sellFileStatus" style="font-size:0.8rem; color:var(--muted); font-style:italic;">No file chosen</span>
          </div>
          <input type="file" id="sellFile" accept="image/*" capture="environment" style="display:none;" />
          <input name="image" id="sellImageInput" placeholder="Or paste image URL..." />
        </div>
        <div class="input">
          <label>Contact</label>
          <input required name="contact" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" type="submit"><i class="ri-upload-2-line"></i> Publish</button>
      </div>
    </form>
  </section>

  <!-- BUSINESS CREATION -->
  <section class="section__container" id="businessSection" style="display:none;"></section>

  <!-- MY DASHBOARD -->
  <section class="section__container" id="mySection" style="display:none;">
    <h2 class="section__header">My Dashboard</h2>
    <div class="tabs" id="myTabs" role="tablist" style="margin-bottom:1rem;">
      <div class="tab active" data-tab="listings">My Items</div>
      <div class="tab" data-tab="orders">Orders</div>
      <div class="tab" data-tab="biz">My Businesses</div>
    </div>
    <div id="myListings">
      <table style="margin-bottom:1rem;"><tbody id="myListingsBody"></tbody></table>
      <div class="empty" id="myListingsEmpty" style="display:none;">No items yet.</div>
    </div>
    <div id="myOrders" style="display:none;">
      <table><tbody id="myOrdersBody"></tbody></table>
      <div class="empty" id="myOrdersEmpty" style="display:none;">No orders yet.</div>
    </div>
    <div id="myBusinesses" style="display:none;">
      <table style="margin-bottom:1rem;"><tbody id="myBizBody"></tbody></table>
      <div class="empty" id="myBizEmpty" style="display:none;">No businesses yet.</div>
    </div>
  </section>

  <!-- CART (keeps original .panel layout) -->
  <aside class="panel" id="cartPanel">
    <div class="panel__header">
      <div class="panel__title">Cart</div>
      <button class="btn btn-outline" id="closeCart"><i class="ri-close-line"></i></button>
    </div>
    <div class="panel__body" id="cartBody"></div>
    <div style="padding:1rem; border-top:1px solid var(--stroke);">
      <div style="display:flex; justify-content:space-between; font-weight:800; margin-bottom:1rem;">
        <span>Total</span><span id="cartTotal">â‚±0.00</span>
      </div>
      <button class="btn" id="checkoutBtn" style="width:100%">Checkout</button>
    </div>
  </aside>

  <!-- PROFILE OVERLAY + SIDEBAR (separate from .panel) -->
  <div id="profileOverlay" class="profile-overlay">
    <aside class="profile-sidebar">
      <div class="profile-sidebar__header">
        <h2>Profile</h2>
        <button class="btn btn-outline" id="closeProfileSidebar">
          <i class="ri-close-line"></i>
        </button>
      </div>

      <div class="profile-sidebar__body">
        <!-- User info -->
        <div class="profile-sidebar__user">
          <div class="profile-avatar-circle profile-avatar-letter">U</div>
          <div>
            <div class="profile-display-name">User Student</div>
            <div class="profile-username">@GoogleStudent</div>
            <div class="profile-email">student@slsu.edu.ph</div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="profile-sidebar__section">
          <div class="profile-sidebar__label">Quick actions</div>
          <button class="profile-pill" id="profileMyDashboard">
            <i class="ri-dashboard-line"></i><span>My Dashboard</span>
          </button>
          <button class="profile-pill" id="profileSell">
            <i class="ri-add-circle-line"></i><span>Sell an Item</span>
          </button>
          <button class="profile-pill" id="profileBusiness">
            <i class="ri-store-2-line"></i><span>Create a Business</span>
          </button>
        </div>

        <!-- Settings -->
        <div class="profile-sidebar__section">
          <div class="profile-sidebar__label">Settings</div>
          <div class="input">
            <label>Display name</label>
            <input id="displayNameInput" />
          </div>
          <div class="input">
            <label>Username</label>
            <input id="usernameInput" />
          </div>
          <button class="btn" id="saveProfileBtn" style="width:100%; margin-top:0.4rem;">
            <i class="ri-save-3-line"></i> Save Profile
          </button>
        </div>

        <!-- Manage Google -->
        <div class="profile-sidebar__section">
          <button class="btn btn-outline" id="goManageGoogle" style="width:100%; justify-content:flex-start;">
            <i class="ri-google-fill"></i><span>Manage Google Account</span>
          </button>
        </div>
      </div>

      <div class="profile-sidebar__footer">
        <button class="btn profile-logout-btn" id="profileLogoutBtn">
          <i class="ri-logout-box-r-line"></i> Logout
        </button>
      </div>
    </aside>
  </div>

  <!-- OWNER PROFILE MODAL -->
  <dialog id="ownerModal" class="modal">
    <div class="modal__content">
      <div style="display:flex; justify-content:space-between; align-items:start;">
        <h2 style="font-size:1.5rem; margin-bottom:1rem;">Owner Profile</h2>
        <button class="btn btn-outline" onclick="document.getElementById('ownerModal').close()" style="padding:0.4rem;">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div id="ownerInfo"></div>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

  <!-- PROFILE + LOGOUT LOGIC -->
  <script>
    // logout used everywhere
    function globalLogout() {
      localStorage.removeItem('slsu_token');
      window.location.href = 'login.html';
    }
    window.logout = globalLogout;

    const PROFILE_KEYS = {
      display: 'slsu_profile_display',
      username: 'slsu_profile_username'
    };

    function loadProfile() {
      const display = localStorage.getItem(PROFILE_KEYS.display) || 'User Student';
      const username = localStorage.getItem(PROFILE_KEYS.username) || 'GoogleStudent';

      document.querySelectorAll('.profile-display-name').forEach(el => el.textContent = display);
      document.querySelectorAll('.profile-username').forEach(el => el.textContent = '@' + username.replace(/^@/, ''));

      const initial = (display.trim()[0] || 'U').toUpperCase();
      document.querySelectorAll('.profile-avatar-letter').forEach(el => {
        el.textContent = initial;
      });

      const displayInput = document.getElementById('displayNameInput');
      const usernameInput = document.getElementById('usernameInput');
      if (displayInput) displayInput.value = display;
      if (usernameInput) usernameInput.value = username;
    }

    const profileOverlay = document.getElementById('profileOverlay');

    document.getElementById('openProfile')?.addEventListener('click', () => {
      profileOverlay.classList.add('open');
      loadProfile();
    });

    document.getElementById('closeProfileSidebar')?.addEventListener('click', () => {
      profileOverlay.classList.remove('open');
    });

    profileOverlay?.addEventListener('click', (e) => {
      if (e.target === profileOverlay) profileOverlay.classList.remove('open');
    });

    document.getElementById('saveProfileBtn')?.addEventListener('click', () => {
      const display = (document.getElementById('displayNameInput').value || 'User Student').trim();
      const username = (document.getElementById('usernameInput').value || 'GoogleStudent').trim();

      localStorage.setItem(PROFILE_KEYS.display, display);
      localStorage.setItem(PROFILE_KEYS.username, username);

      loadProfile();
      if (typeof toast === 'function') toast('Profile updated');
    });

    document.getElementById('profileMyDashboard')?.addEventListener('click', () => {
      if (typeof route === 'function') route('my');
      profileOverlay.classList.remove('open');
    });

    document.getElementById('profileSell')?.addEventListener('click', () => {
      if (typeof route === 'function') route('sell');
      profileOverlay.classList.remove('open');
    });

    document.getElementById('profileBusiness')?.addEventListener('click', () => {
      if (typeof route === 'function') route('business');
      profileOverlay.classList.remove('open');
    });

    document.getElementById('goManageGoogle')?.addEventListener('click', () => {
      window.open('https://myaccount.google.com', '_blank');
    });

    document.getElementById('profileLogoutBtn')?.addEventListener('click', () => {
      globalLogout();
    });

    // Initial avatar text
    loadProfile();
  </script>

  <script src="scripts/boot.js" defer></script>
</body>
</html>
