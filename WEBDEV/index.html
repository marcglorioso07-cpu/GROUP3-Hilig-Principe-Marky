<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- AUTH CHECK -->
    <script>
        if (!localStorage.getItem('slsu_token')) { window.location.href = 'login.html'; }
    </script>
    <title>SLSU Marketplace</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/marketplace.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
</head>
<body>
    <!-- NAV -->
    <nav>
        <div class="nav__inner">
            <div class="nav__logo">
                <img src="assets/logo.png" alt="SLSU" onerror="this.style.display='none'" />
                <span class="site-title">SLSU <span class="accent">Marketplace</span></span>
            </div>
            
            <div style="flex:1;"></div> 
            
            <div class="toolbar" style="display:flex; gap:1rem; align-items:center;">
                <button class="btn btn-outline" onclick="route('browse')">Browse</button>
                <button class="btn btn-outline" onclick="route('my')">My Dashboard</button>

                <!-- Cart Button -->
                <button class="btn btn-outline" id="openCart" style="padding:0.5rem 0.8rem;">
                    <i class="ri-shopping-cart-2-line"></i><span id="cartCount">0</span>
                </button>

                <!-- PROFILE BUTTON (opens sidebar) -->
                <div class="profile-dropdown">
                    <button class="profile-btn" id="openProfile">
                        <div class="avatar" id="navAvatar">U</div>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <header class="section__container" id="heroHeader">
        <div class="hero-banner">
            <h1>Buy & Sell within SLSU</h1>
            <div class="searchbar">
                <input type="text" id="q" placeholder="Search items..." />
                <button class="btn" id="runSearch"><i class="ri-search-line"></i> Search</button>
            </div>
        </div>
    </header>

    <!-- BROWSE LAYOUT -->
    <section class="section__container" id="browseSection">
        <div class="category-scroll-container">
            <div id="categoryIcons" class="category-row"></div>
        </div>

        <div class="browse-layout-grid">
            <div class="browse-main">
                <div class="section-flex-header">
                    <h2 class="section-title">Active Shops</h2>
                    <button class="btn-link" onclick="viewAllBiz()">View All <i class="ri-arrow-right-line"></i></button>
                </div>
                <div id="featuredBizRow" class="featured-biz-row"></div>

                <h2 class="section-title" style="margin-top:2rem; margin-bottom:1rem;">Fresh Listings</h2>
                <div class="grid grid-3" id="listings"></div>
                <div class="empty" id="emptyListings" style="display:none;">
                    <i class="ri-store-2-line"></i> No items match your filters yet.
                </div>
            </div>

            <aside class="browse-sidebar">
                <div class="sidebar-header">
                    <h3>Top Rated</h3>
                    <span style="font-size:0.8rem; color:var(--accent);">Live Now</span>
                </div>
                <div id="activeBizList" class="ranked-list"></div>
            </aside>
        </div>
    </section>

    <!-- BUSINESS DETAIL PAGE -->
    <section class="section__container" id="businessPage" style="display:none;">
        <button class="btn btn-outline" onclick="route('browse')" style="margin-bottom:1rem;">
            <i class="ri-arrow-left-line"></i> Back to Marketplace
        </button>
        <div id="bizHeader" style="background:var(--surface-2); padding:2rem; border-radius:20px; border:1px solid var(--stroke); margin-bottom:2rem; display:flex; gap:1.5rem; flex-wrap:wrap;"></div>
        <h3 class="section__header" id="bizItemsTitle" style="font-size:1.5rem;">Menu & Services</h3>
        <div class="grid grid-3" id="bizItemsGrid"></div>
        <div class="empty" id="bizItemsEmpty" style="display:none;">
            <i class="ri-file-list-3-line"></i> This business hasn't listed any items yet.
        </div>
    </section>

    <!-- SELL FORM -->
    <section class="section__container" id="sellSection" style="display:none;">
        <h2 class="section__header">List an item / Add to Menu</h2>
        <form id="sellForm" class="form">
            <input type="hidden" name="businessId" id="linkToBizId" value="" />
            <div id="bizLinkNotice" style="background:rgba(34,197,94,.1); color:#86efac; padding:0.8rem; border-radius:8px; display:none; margin-bottom:1rem;">
                <i class="ri-link"></i> Adding this item to your business: <b id="bizLinkName"></b>
            </div>
            <div class="grid grid-2">
                <div class="input">
                    <label>Item Title</label>
                    <input required name="title" placeholder="e.g., Cheese Burger" />
                </div>
                <div class="input">
                    <label>Price (PHP)</label>
                    <input required name="price" type="number" min="0" step="0.01" />
                </div>
            </div>
            <div class="grid grid-2">
                <div class="input">
                    <label>Category</label>
                    <select name="category" required>
                        <option value="Food & Drinks">Food & Drinks</option>
                        <option value="Services">Services</option>
                        <option value="Merch & Printing">Merch & Printing</option>
                        <option value="Books">Books</option>
                        <option value="Uniforms">Uniforms</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div class="input">
                    <label>Condition</label>
                    <select name="condition" required>
                        <option>New / Fresh</option>
                        <option>Service</option>
                        <option>Like New</option>
                        <option>Good</option>
                    </select>
                </div>
            </div>
            <div class="input">
                <label>Description</label>
                <textarea name="description" rows="4"></textarea>
            </div>
            <div class="grid grid-2">
                <div class="input">
                    <label>Photo</label>
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                        <label for="sellFile" class="btn" style="padding:0.6rem 1rem; width:auto;">
                            <i class="ri-camera-fill"></i> Take Photo
                        </label>
                        <span id="sellFileStatus" style="font-size:0.8rem; color:var(--muted); font-style:italic;">No file chosen</span>
                    </div>
                    <input type="file" id="sellFile" accept="image/*" capture="environment" style="display:none;" />
                    <input name="image" id="sellImageInput" placeholder="Or paste image URL..." />
                </div>
                <div class="input">
                    <label>Contact</label>
                    <input required name="contact" />
                </div>
            </div>
            <div class="toolbar">
                <button class="btn" type="submit"><i class="ri-upload-2-line"></i> Publish</button>
            </div>
        </form>
    </section>

    <!-- BUSINESS CREATION -->
    <section class="section__container" id="businessSection" style="display:none;"></section>

    <!-- MY DASHBOARD -->
    <section class="section__container" id="mySection" style="display:none;">
        <h2 class="section__header">My Dashboard</h2>
        <div class="tabs" id="myTabs" role="tablist" style="margin-bottom:1rem;">
            <div class="tab active" data-tab="listings">My Items</div>
            <div class="tab" data-tab="orders">Orders</div>
            <div class="tab" data-tab="biz">My Businesses</div>
        </div>
        <div id="myListings">
            <table style="margin-bottom:1rem;"><tbody id="myListingsBody"></tbody></table>
            <div class="empty" id="myListingsEmpty" style="display:none;">No items yet.</div>
        </div>
        <div id="myOrders" style="display:none;">
            <table><tbody id="myOrdersBody"></tbody></table>
            <div class="empty" id="myOrdersEmpty" style="display:none;">No orders yet.</div>
        </div>
        <div id="myBusinesses" style="display:none;">
            <table style="margin-bottom:1rem;"><tbody id="myBizBody"></tbody></table>
            <div class="empty" id="myBizEmpty" style="display:none;">No businesses yet.</div>
        </div>
    </section>

    <!-- CART -->
    <aside class="panel" id="cartPanel">
        <div class="panel__header">
            <div class="panel__title">Cart</div>
            <button class="btn btn-outline" id="closeCart"><i class="ri-close-line"></i></button>
        </div>
        <div class="panel__body" id="cartBody"></div>
        <div style="padding:1rem; border-top:1px solid var(--stroke);">
            <div style="display:flex; justify-content:space-between; font-weight:800; margin-bottom:1rem;">
                <span>Total</span><span id="cartTotal">â‚±0.00</span>
            </div>
            <button class="btn" id="checkoutBtn" style="width:100%">Checkout</button>
        </div>
    </aside>

    <!-- PROFILE SIDEBAR -->
    <aside class="panel" id="profilePanel">
        <div class="panel__header">
            <div style="display:flex; align-items:center; gap:0.8rem;">
                <div class="avatar avatar-lg" id="profileAvatar">U</div>
                <div>
                    <div id="profileName" style="font-weight:700;">SLSU Student</div>
                    <div id="profileEmail" style="font-size:0.8rem; color:var(--muted);">Signed in</div>
                </div>
            </div>
            <button class="btn btn-outline" id="closeProfile" style="padding:0.4rem 0.6rem;">
                <i class="ri-close-line"></i>
            </button>
        </div>

        <div class="panel__body">
            <!-- Quick Links -->
            <div class="profile-section">
                <div class="profile-section-label">Quick links</div>
                <div class="profile-link-list">
                    <button class="profile-link" data-route="my">
                        <i class="ri-dashboard-line"></i>
                        <span>My Dashboard</span>
                    </button>
                    <button class="profile-link" data-route="sell">
                        <i class="ri-add-circle-line"></i>
                        <span>Sell an Item</span>
                    </button>
                    <button class="profile-link" data-route="business">
                        <i class="ri-store-2-line"></i>
                        <span>Create a Business</span>
                    </button>
                </div>
            </div>

            <!-- Settings shortcuts -->
            <div class="profile-section">
                <div class="profile-section-label">Settings</div>
                <div class="profile-link-list">
                    <button class="profile-link" data-action="edit-profile">
                        <i class="ri-user-settings-line"></i>
                        <span>Edit profile</span>
                    </button>
                    <button class="profile-link" data-action="edit-username">
                        <i class="ri-edit-2-line"></i>
                        <span>Edit username</span>
                    </button>
                    <button class="profile-link" data-action="manage-google">
                        <i class="ri-google-fill"></i>
                        <span>Manage Google account</span>
                    </button>
                </div>
            </div>

            <!-- Profile form -->
            <div class="profile-section" id="profileEditSection">
                <div class="profile-section-label">Profile details</div>
                <form id="profileForm" class="profile-form">
                    <div class="input">
                        <label for="profileUsername">Display name / username</label>
                        <input id="profileUsername" name="profileUsername" placeholder="e.g. juan.delacruz" />
                    </div>

                    <div class="input">
                        <label>Profile picture</label>
                        <div style="display:flex; align-items:center; gap:0.75rem;">
                            <label for="profileAvatarFile" class="btn" style="padding:0.6rem 1rem; width:auto;">
                                <i class="ri-camera-fill"></i> Upload photo
                            </label>
                            <span id="profileAvatarStatus" style="font-size:0.8rem; color:var(--muted); font-style:italic;">
                                JPG/PNG, small file
                            </span>
                        </div>
                        <input type="file" id="profileAvatarFile" accept="image/*" style="display:none;">
                    </div>

                    <div class="toolbar">
                        <button class="btn" type="submit" style="width:100%;">
                            <i class="ri-save-3-line"></i> Save profile
                        </button>
                    </div>
                </form>
            </div>

            <div class="profile-section">
                <button class="btn btn-outline" type="button" onclick="logout()" style="width:100%; color:#fca5a5; border-color:#b91c1c;">
                    <i class="ri-logout-box-r-line"></i> Logout
                </button>
            </div>
        </div>
    </aside>

    <!-- OWNER PROFILE MODAL -->
    <dialog id="ownerModal" class="modal">
        <div class="modal__content">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h2 style="font-size:1.5rem; margin-bottom:1rem;">Owner Profile</h2>
                <button class="btn btn-outline" onclick="document.getElementById('ownerModal').close()" style="padding:0.4rem;"><i class="ri-close-line"></i></button>
            </div>
            <div id="ownerInfo"></div>
        </div>
    </dialog>

    <div class="toast" id="toast"></div>

    <!-- PROFILE + LOGOUT SCRIPT -->
    <script>
        const PROFILE_KEY = 'slsu_profile';
        const TOKEN_KEY = 'slsu_token';

        function getProfile() {
            try {
                return JSON.parse(localStorage.getItem(PROFILE_KEY)) || null;
            } catch (e) {
                return null;
            }
        }

        function saveProfile(profile) {
            localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
        }

        function applyProfileUI() {
            let profile = getProfile();

            if (!profile) {
                profile = {
                    username: 'SLSU Student',
                    email: '',
                    provider: 'local',
                    avatar: ''
                };
                saveProfile(profile);
            }

            const avatarSmall = document.getElementById('navAvatar');
            const avatarLarge = document.getElementById('profileAvatar');
            const nameEl = document.getElementById('profileName');
            const emailEl = document.getElementById('profileEmail');
            const usernameInput = document.getElementById('profileUsername');

            if (nameEl) nameEl.textContent = profile.username || 'SLSU Student';
            if (emailEl) {
                emailEl.textContent = profile.email
                    ? profile.email
                    : (profile.provider ? profile.provider.toUpperCase() + ' account' : 'Signed in');
            }
            if (usernameInput) usernameInput.value = profile.username || '';

            [avatarSmall, avatarLarge].forEach(el => {
                if (!el) return;
                if (profile.avatar) {
                    el.style.backgroundImage = `url(${profile.avatar})`;
                    el.style.backgroundSize = 'cover';
                    el.style.backgroundPosition = 'center';
                    el.textContent = '';
                } else {
                    el.style.backgroundImage = '';
                    const initial = (profile.username || 'S').charAt(0).toUpperCase();
                    el.textContent = initial;
                }
            });

            // First-time users: open the profile sidebar automatically
            if ((!profile.username || profile.username === 'SLSU Student') &&
                document.getElementById('profilePanel')) {
                document.getElementById('profilePanel').classList.add('open');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const profilePanel = document.getElementById('profilePanel');

            document.getElementById('openProfile')?.addEventListener('click', () => {
                profilePanel?.classList.add('open');
            });

            document.getElementById('closeProfile')?.addEventListener('click', () => {
                profilePanel?.classList.remove('open');
            });

            // Quick links (Dashboard / Sell / Create Biz)
            document.querySelectorAll('.profile-link[data-route]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const r = btn.dataset.route;
                    if (typeof route === 'function') route(r);
                    profilePanel?.classList.remove('open');
                });
            });

            // Settings shortcuts
            document.querySelectorAll('.profile-link[data-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (action === 'edit-profile' || action === 'edit-username') {
                        document.getElementById('profileForm')
                            ?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    if (action === 'manage-google') {
                        window.open('https://myaccount.google.com', '_blank');
                    }
                });
            });

            // Save profile form
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const profile = getProfile() || {};
                    const username = document.getElementById('profileUsername').value.trim();
                    if (username) profile.username = username;
                    saveProfile(profile);
                    applyProfileUI();
                    if (typeof toast === 'function') toast('Profile updated');
                });
            }

            // Avatar upload
            const avatarFile = document.getElementById('profileAvatarFile');
            if (avatarFile) {
                avatarFile.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    document.getElementById('profileAvatarStatus').textContent = file.name;

                    const reader = new FileReader();
                    reader.onload = ev => {
                        const profile = getProfile() || {};
                        profile.avatar = ev.target.result;
                        saveProfile(profile);
                        applyProfileUI();
                    };
                    reader.readAsDataURL(file);
                });
            }

            applyProfileUI();
        });

        window.logout = () => {
            localStorage.removeItem(TOKEN_KEY);
            window.location.href = 'login.html';
        };
    </script>

    <script src="scripts/boot.js" defer></script>
</body>
</html>
