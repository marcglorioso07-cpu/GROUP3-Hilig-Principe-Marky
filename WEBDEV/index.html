<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLSU Marketplace</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/marketplace.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
</head>
<body>
    <!-- NAV -->
    <nav>
        <div class="nav__inner">
            <div class="nav__logo">
                <img src="assets/logo.png" alt="SLSU" onerror="this.style.display='none'" />
                <span class="site-title">SLSU <span class="accent">Marketplace</span></span>
            </div>
            
            <div id="linksMount"></div>

            <div class="toolbar">
                <button class="btn btn-outline" id="openCart" style="padding:0.5rem 0.8rem;">
                    <i class="ri-shopping-cart-2-line"></i> <span id="cartCount" style="font-size:0.9rem;">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <header class="section__container" id="heroHeader">
        <h1 class="section__header">Buy & Sell within SLSU</h1>
        <p class="section__subheader">Campus-only marketplace for students and staff.</p>
        <div class="searchbar" style="margin-top:1rem;">
            <input type="text" id="q" placeholder="Search items..." />
            <select id="cat">
                <option value="">All categories</option>
                <option>Food & Drinks</option>
                <option>Services</option>
                <option>Books</option>
                <option>Uniforms</option>
                <option>Electronics</option>
                <option>Others</option>
            </select>
            <select id="sort">
                <option value="latest">Latest</option>
                <option value="price_asc">Price: Low → High</option>
                <option value="price_desc">Price: High → Low</option>
            </select>
            <button class="btn" id="runSearch"><i class="ri-search-line"></i> Search</button>
        </div>
    </header>

    <!-- BROWSE LISTINGS -->
    <section class="section__container" id="browseSection">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:.6rem;">
            <h2 class="section__header" style="font-size:1.4rem;">Marketplace</h2>
            <div class="tabs" id="viewTabs" role="tablist">
                <div class="tab active" data-view="all">All Items</div>
                <div class="tab" data-view="businesses">Businesses</div>
                <div class="tab" data-view="books">Books</div>
                <div class="tab" data-view="electronics">Electronics</div>
            </div>
        </div>
        <div class="grid grid-3" id="listings"></div>
        <div class="empty" id="emptyListings" style="display:none;">
            <i class="ri-store-2-line"></i> No items match your filters yet.
        </div>
    </section>

    <!-- BUSINESS DETAIL PAGE -->
    <section class="section__container" id="businessPage" style="display:none;">
        <button class="btn btn-outline" onclick="route('browse')" style="margin-bottom:1rem;">
            <i class="ri-arrow-left-line"></i> Back to Marketplace
        </button>
        <div id="bizHeader" style="background:var(--surface-2); padding:2rem; border-radius:20px; border:1px solid var(--stroke); margin-bottom:2rem; display:flex; gap:1.5rem; flex-wrap:wrap;"></div>
        <h3 class="section__header" id="bizItemsTitle" style="font-size:1.5rem;">Menu & Services</h3>
        <div class="grid grid-3" id="bizItemsGrid"></div>
        <div class="empty" id="bizItemsEmpty" style="display:none;">
            <i class="ri-file-list-3-line"></i> This business hasn't listed any items yet.
        </div>
    </section>

    <!-- SELL FORM -->
    <section class="section__container" id="sellSection" style="display:none;">
        <h2 class="section__header">List an item / Add to Menu</h2>
        <p class="section__subheader" style="margin-bottom:1rem;">Create a listing or add a product to your business.</p>
        <form id="sellForm" class="form">
            <input type="hidden" name="businessId" id="linkToBizId" value="" />
            <div id="bizLinkNotice" style="background:rgba(34,197,94,.1); color:#86efac; padding:0.8rem; border-radius:8px; display:none; margin-bottom:1rem;">
                <i class="ri-link"></i> Adding this item to your business: <b id="bizLinkName"></b>
            </div>
            <div class="grid grid-2">
                <div class="input">
                    <label>Item Title / Service Name</label>
                    <input required name="title" placeholder="e.g., Cheese Burger or Laptop Repair" />
                </div>
                <div class="input">
                    <label>Price (PHP)</label>
                    <input required name="price" type="number" min="0" step="0.01" placeholder="e.g., 50" />
                </div>
            </div>
            <div class="grid grid-2">
                <div class="input">
                    <label>Category</label>
                    <select name="category" required>
                        <option value="Food & Drinks">Food & Drinks</option>
                        <option value="Services">Services</option>
                        <option value="Merch & Printing">Merch & Printing</option>
                        <option value="Books">Books</option>
                        <option value="Uniforms">Uniforms</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div class="input">
                    <label>Condition</label>
                    <select name="condition" required>
                        <option>New / Fresh</option>
                        <option>Service</option>
                        <option>Like New</option>
                        <option>Good</option>
                        <option>Fair</option>
                    </select>
                </div>
            </div>
            <div class="input">
                <label>Description</label>
                <textarea name="description" rows="4" placeholder="Ingredients, details, or service inclusions..."></textarea>
            </div>
            <div class="grid grid-2">
                <div class="input">
                    <label>Photo</label>
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.3rem;">
                        <label for="sellFile" class="btn" style="padding:0.6rem 1rem; width:auto;">
                            <i class="ri-camera-fill"></i> Take Photo
                        </label>
                        <span id="sellFileStatus" style="font-size:0.8rem; color:var(--muted); font-style:italic;">No file chosen</span>
                    </div>
                    <input type="file" id="sellFile" accept="image/*" capture="environment" style="display:none;" />
                    <input name="image" id="sellImageInput" placeholder="Or paste image URL..." />
                </div>
                <div class="input">
                    <label>Contact</label>
                    <input required name="contact" placeholder="e.g., 09xx" />
                </div>
            </div>
            <div class="toolbar">
                <button class="btn" type="submit"><i class="ri-upload-2-line"></i> Publish</button>
                <button class="btn btn-outline" type="reset"><i class="ri-eraser-line"></i> Reset</button>
            </div>
        </form>
    </section>

    <!-- BUSINESS CREATION -->
    <section class="section__container" id="businessSection" style="display:none;"></section>

    <!-- MY DASHBOARD -->
    <section class="section__container" id="mySection" style="display:none;">
        <h2 class="section__header">My Dashboard</h2>
        <div class="tabs" id="myTabs" role="tablist" style="margin-bottom:1rem;">
            <div class="tab active" data-tab="listings">My Items</div>
            <div class="tab" data-tab="orders">Orders</div>
            <div class="tab" data-tab="biz">My Businesses</div>
        </div>
        <div id="myListings">
            <table style="margin-bottom:1rem;"><tbody id="myListingsBody"></tbody></table>
            <div class="empty" id="myListingsEmpty" style="display:none;">No items yet.</div>
        </div>
        <div id="myOrders" style="display:none;">
            <table><tbody id="myOrdersBody"></tbody></table>
            <div class="empty" id="myOrdersEmpty" style="display:none;">No orders yet.</div>
        </div>
        <div id="myBusinesses" style="display:none;">
            <table style="margin-bottom:1rem;"><tbody id="myBizBody"></tbody></table>
            <div class="empty" id="myBizEmpty" style="display:none;">No businesses yet.</div>
        </div>
    </section>

    <!-- OVERLAY (Backdrop) -->
    <div id="overlay" class="overlay" aria-hidden="true"></div>

    <!-- PROFILE SIDEBAR (Drawer) -->
    <aside class="panel profile-panel" id="profilePanel" aria-hidden="true">
        <div style="padding:1.5rem; border-bottom:1px solid var(--stroke); background:var(--surface-1);">
             <div style="display:flex; justify-content:space-between; align-items:start;">
                 <!-- This avatar is now updated dynamically via JS -->
                 <div class="sidebar-avatar" style="width:60px; height:60px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.8rem; color:#000; font-weight:700; box-shadow:0 0 20px rgba(34,197,94,0.2); overflow:hidden;">
                    U
                 </div>
                 <button class="btn btn-outline" id="closeProfile" style="padding:0.4rem; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center;"><i class="ri-close-line"></i></button>
             </div>
             <div style="margin-top:1rem;">
                 <h2 id="sidebarName" style="font-size:1.2rem; font-weight:700;">User Student</h2>
                 <p style="color:var(--muted); font-size:0.9rem;">Student ID: 12345</p>
             </div>
        </div>
        <div class="panel__body" style="padding:1rem;">
            <div style="display:grid; gap:0.5rem;">
                <h4 style="font-size:0.8rem; text-transform:uppercase; color:var(--muted); margin-bottom:0.5rem; margin-top:0.5rem; padding-left:0.5rem;">Menu</h4>
                <a href="#my" data-route="my" class="profile-link"><i class="ri-dashboard-line"></i> My Dashboard</a>
                <a href="#sell" data-route="sell" class="profile-link"><i class="ri-add-circle-line"></i> Sell an Item</a>
                <a href="#business" data-route="business" class="profile-link"><i class="ri-store-2-line"></i> Create a Business</a>
                
                <!-- NEW SETTINGS LINK -->
                <a href="#" id="openSettingsBtn" class="profile-link"><i class="ri-settings-3-line"></i> Settings</a>

                <div style="border-top:1px solid var(--stroke); margin:0.5rem 0;"></div>
                <a href="#" class="profile-link logout" onclick="alert('Logged out!')"><i class="ri-logout-box-line"></i> Logout</a>
            </div>
        </div>
    </aside>

    <!-- CART SIDEBAR -->
    <aside class="panel" id="cartPanel">
        <div class="panel__header">
            <div class="panel__title">Cart</div>
            <button class="btn btn-outline" id="closeCart"><i class="ri-close-line"></i></button>
        </div>
        <div class="panel__body" id="cartBody"></div>
        <div style="padding:1rem; border-top:1px solid var(--stroke);">
            <div style="display:flex; justify-content:space-between; font-weight:800; margin-bottom:1rem;">
                <span>Total</span><span id="cartTotal">₱0.00</span>
            </div>
            <button class="btn" id="checkoutBtn" style="width:100%">Checkout</button>
        </div>
    </aside>

    <!-- OWNER MODAL -->
    <dialog id="ownerModal" class="modal">
        <div class="modal__content">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h2 style="font-size:1.5rem; margin-bottom:1rem;">Owner Profile</h2>
                <button class="btn btn-outline" onclick="closeOwnerModal()" style="padding:0.4rem;"><i class="ri-close-line"></i></button>
            </div>
            <div id="ownerInfo"></div>
        </div>
    </dialog>

    <!-- SETTINGS MODAL (New) -->
    <dialog id="settingsModal" class="modal">
        <div class="modal__content" style="max-width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h2 style="font-size:1.5rem; font-weight:700;">Account Settings</h2>
                <button class="btn btn-outline" onclick="closeSettingsModal()" style="padding:0.4rem;"><i class="ri-close-line"></i></button>
            </div>
            
            <form id="settingsForm" class="form">
                <!-- Google Connect Section -->
                <div style="background:var(--surface-3); padding:1rem; border-radius:12px; margin-bottom:1rem; border:1px solid var(--stroke);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h4 style="font-weight:600; margin-bottom:0.2rem;">Google Account</h4>
                            <p style="font-size:0.85rem; color:var(--muted);" id="googleStatusText">Not connected</p>
                        </div>
                        <button type="button" id="googleBtn" class="btn-google">
                            <i class="ri-google-fill"></i> Connect
                        </button>
                    </div>
                </div>

                <div class="input">
                    <label>Profile Picture</label>
                    <div style="display:flex; align-items:center; gap:1rem;">
                        <div id="settingsAvatarPreview" style="width:50px; height:50px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; overflow:hidden; color:#000; font-weight:700;">U</div>
                        <div style="flex:1;">
                            <label for="settingsFile" class="btn btn-outline" style="padding:0.5rem 1rem; font-size:0.9rem; width:auto; display:inline-flex;">
                                <i class="ri-upload-cloud-2-line"></i> Upload New
                            </label>
                            <input type="file" id="settingsFile" accept="image/*" style="display:none;" />
                            <input type="hidden" name="avatar" id="settingsAvatarInput" />
                        </div>
                    </div>
                </div>

                <div class="input">
                    <label>Display Name</label>
                    <input name="username" id="settingsName" placeholder="e.g. User Student" />
                </div>

                <div class="input">
                    <label>Student ID / Bio</label>
                    <input name="bio" id="settingsBio" placeholder="e.g. 12345 or Computer Engineering" />
                </div>

                <div class="toolbar" style="margin-top:1rem;">
                    <button class="btn" type="submit" style="width:100%"><i class="ri-save-3-line"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </dialog>

    <div class="toast" id="toast"></div>
    <script src="scripts/boot.js" defer></script>
</body>
</html>
